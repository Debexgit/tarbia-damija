<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅูููุฌุฑุงููู: ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูู ุงูุชุนููู ุงูุฃููู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            height: 380px;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 450px;
            }
        }
        .flowchart-step {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .flowchart-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .flowchart-arrow {
            font-size: 2.5rem;
            line-height: 1;
            color: #FFD166;
        }
         .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 0.5rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #118AB2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
         /* Custom button style for LLM features */
        .llm-button {
            background-image: linear-gradient(to right, #118AB2 0%, #073B4C 100%);
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .llm-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
         .image-preview {
            max-height: 150px;
            width: auto;
            border-radius: 0.5rem;
            object-fit: contain;
            margin-top: 1rem;
            border: 1px solid #ccc;
        }
        /* Specific styling for structured output */
        .structured-output strong {
             display: block;
             margin-top: 0.75rem;
             margin-bottom: 0.25rem;
             color: #118AB2;
             font-size: 1.125rem; /* lg */
             border-bottom: 2px solid #06D6A0;
             padding-bottom: 4px;
        }
        .structured-output ul {
            list-style-type: disc;
            margin-right: 1.5rem;
            padding-right: 0.5rem;
            margin-top: 0.5rem;
        }
        .structured-output li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <header class="bg-[#073B4C] text-white p-8 text-center shadow-lg">
        <h1 class="text-4xl font-bold mb-2">ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู</h1>
        <p class="text-xl text-gray-300">ุงููุญุงูุฑ ุงูุฃุฑุจุนุฉ: ุงููููููุ ุงูุฅุนุงูุงุชุ ุงูุฅุณุงุกุฉุ ูุงูุญูุงูุฉ</p>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <!-- GEMINI API FEATURE: Activity Idea Generator (NEW) -->
        <section id="activity-generator" class="mb-12 bg-[#06D6A0] p-6 rounded-lg shadow-xl relative">
            <h2 class="text-3xl font-bold text-center text-white mb-6">โจ ููููุฏ ุงูุฃูุดุทุฉ ุงูุฏุงูุฌุฉ</h2>
            <p class="text-center text-gray-100 max-w-4xl mx-auto mb-6">
                ุฃุฏุฎู ููุถูุนูุง ุฏุฑุงุณููุง ุฃู ูุดุงุทูุง ุนุงููุง (ูุซู "ุงูุญููุงูุงุช ุงูุฃูููุฉ" ุฃู "ุชุนููู ุงูุฃุฑูุงู 1-5") ูุชุญุตู ุนูู ูุดุงุท ุชุทุจููู ูุน ุชูุตูุงุช ุฏูุฌ ููุฑูุฉ.
            </p>

            <div class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="activity-topic" class="block text-sm font-medium text-gray-700 mb-1 text-right">ุงูููุถูุน ุฃู ุงููุฏู ุงูุชุนูููู</label>
                    <input type="text" id="activity-topic" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#06D6A0] text-right w-full" placeholder="ูุซุงู: ุงูุชุนุฑู ุนูู ุงูุฃุดูุงู ุงูููุฏุณูุฉ ุงูุฃุณุงุณูุฉ">
                </div>
                 <div>
                    <label for="activity-duration" class="block text-sm font-medium text-gray-700 mb-1 text-right">ุงููุฏุฉ ุงูููุชุฑุญุฉ (ุฏูููุฉ)</label>
                    <select id="activity-duration" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#06D6A0] text-right w-full">
                        <option value="15">15 ุฏูููุฉ</option>
                        <option value="20">20 ุฏูููุฉ</option>
                        <option value="30" selected>30 ุฏูููุฉ</option>
                    </select>
                </div>
                
                <button onclick="generateInclusiveActivity()" class="llm-button py-3 px-4 rounded-lg shadow-md flex items-center justify-center bg-gradient-to-r from-[#118AB2] to-[#073B4C]">
                    โจ ุชูููุฏ ูุดุงุท ุฏุงูุฌ
                </button>
            </div>
            
            <div id="activity-result-container" class="mt-6 bg-slate-100 p-6 rounded-lg relative min-h-[100px]">
                <div id="activity-loading" class="loading-overlay hidden">
                    <div class="spinner"></div>
                    <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุงูุชูููุฏ... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                </div>
                <div id="activity-result" class="text-right text-gray-800">
                    <!-- Results will appear here -->
                    <p class="text-gray-500 italic">ุณูุชู ุนุฑุถ ุชูุงุตูู ุงููุดุงุท ูุน ุงูุชููููุงุช ุงูููุชุฑุญุฉ ููุง.</p>
                </div>
            </div>
        </section>


        <section id="introduction" class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#118AB2] mb-6">ุงููุดุงุท ุงูุฃูู: ููููู ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูุฎุตุงุฆุตูุง</h2>
            <div class="bg-white rounded-lg shadow-xl p-6 mb-8 text-center border-b-4 border-[#118AB2]">
                <h3 class="text-2xl font-bold text-[#073B4C] mb-4">ุงูุชุนุฑูู ูุงูุฃูุฏุงู ุงูุฌููุฑูุฉ</h3>
                <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                    <p id="inclusive-definition" class="text-lg max-w-4xl mx-auto md:w-3/4">
                        ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูู ูุธุงู ุชุฑุจูู ูุถูู **ุญู ูู ุทูู** ูู ุงูุญุตูู ุนูู ุชุนููู ุฐู ุฌูุฏุฉ ูู ุจูุฆุฉ ูุดุชุฑูุฉุ ุจูุฏู ุงููุถุงุก ุนูู ุฌููุน ุฃุดูุงู ุงูุชูููุฒ ูุชุนุฒูุฒ **ุงูุฅูุตุงู ูุชูุงูุค ุงููุฑุต** ููุฌููุน ูู ุงูุชูุฏุฑุณ.
                    </p>
                    <button onclick="readDefinition()" class="bg-[#06D6A0] text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-[#05a57c] transition duration-150 flex items-center justify-center md:w-1/4 min-w-[150px]">
                        ๐ ุงูุฑุฃ ุงูุชุนุฑูู (TTS)
                    </button>
                    <audio id="tts-audio" class="hidden"></audio>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8 text-center">
                <div class="bg-[#06D6A0] text-white p-6 rounded-lg shadow-md flex flex-col justify-center h-40">
                    <h4 class="text-xl font-bold mb-2">ุงุญุชุฑุงู ุงููุฑููุงุช</h4>
                    <p class="text-sm">ุงูุงุนุชุฑุงู ุจุงูุงุฎุชูุงูุงุช ุงููุฑุฏูุฉ ูุงุนุชุจุงุฑูุง ูุตุฏุฑ ุบูู ูููุณ ุนุงุฆูุงู.</p>
                </div>
                <div class="bg-[#FFD166] text-[#073B4C] p-6 rounded-lg shadow-md flex flex-col justify-center h-40">
                    <h4 class="text-xl font-bold mb-2">ูุฏุฑุฉ ุงูุทูู ุนูู ุงูุชุนูู</h4>
                    <p class="text-sm">ุงูุชุฃููุฏ ุนูู ุฃู ูู ุทููุ ูููุง ูุงูุช ุฎุตูุตูุงุชูุ ููุชูู ุงููุฏุฑุฉ ุนูู ุงูุชุทูุฑ ูุงูุชุนูู.</p>
                </div>
                <div class="bg-[#FF6B6B] text-white p-6 rounded-lg shadow-md flex flex-col justify-center h-40">
                    <h4 class="text-xl font-bold mb-2">ุงูุชููู ุงููุฑุฏู</h4>
                    <p class="text-sm">ุงูุฏุนูุฉ ุฅูู ุชูููู ุงูุจูุฆุฉ ูุงูุฃูุดุทุฉ ููุณุงุนุฏุฉ ูู ุทูู ุนูู ุจููุบ ุฃูุตู ุฅููุงูุงุชู.</p>
                </div>
                <div class="bg-[#118AB2] text-white p-6 rounded-lg shadow-md flex flex-col justify-center h-40">
                    <h4 class="text-xl font-bold mb-2">ุฎูู ุฌู ูุดุฌุน</h4>
                    <p class="text-sm">ุงูุนูู ุนูู ุชูููุฑ ุฌู ูุดุฌุน ููุฑูุญ ูุจุนุซ ุนูู ุงูุชูุจู ูุงูุงุญุชุฑุงู ุงููุชุจุงุฏู ุจูู ุงูุฃุทูุงู.</p>
                </div>
            </div>
        </section>

        <section id="disabilities" class="mb-12">
             <h2 class="text-3xl font-bold text-center text-[#118AB2] mb-6">ุงููุดุงุท ุงูุซุงูู: ุงูุฃุทูุงู ูู ูุถุนูุฉ ุฅุนุงูุฉ ูููุงุฑุณุงุช ุงููุฑุจู</h2>
             <div class="bg-white rounded-lg shadow-xl p-6 grid grid-cols-1 md:grid-cols-3 gap-8 items-center mb-8">
                <div class="md:col-span-1">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-4">ุงูุฅุทุงุฑ ุงููุงูููู ูุฃููุงุน ุงูุชุญุฏูุงุช</h3>
                    <div class="bg-slate-100 p-4 rounded-lg border-r-4 border-[#06D6A0] mb-4">
                        <p class="font-semibold text-lg text-[#073B4C]">ุงููุงููู ุงูุฅุทุงุฑ 13-97</p>
                        <p class="text-sm">ูุญูุงูุฉ ุญููู ุงูุฃุดุฎุงุต ูู ูุถุนูุฉ ุฅุนุงูุฉ ูุถูุงู ูุดุงุฑูุชูู ุงููุงููุฉ ูู ุงููุฌุชูุน ููู ุงูุนูููุฉ ุงูุชุนููููุฉ.</p>
                    </div>
                    <p class="text-base">ุชุชุทูุจ ุงูุฏุงูุฌุฉ ููููุง ูุฃููุงุน ุงูุฅุนุงูุงุช ุงูุชู ุชุคุซุฑ ุนูู ุงูุชุณุงุจ ุงูููุงุฑุงุช ุงูุฃูุงุฏูููุฉ (ูุซู ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ูุงูุญุณุงุจ) ุฃู ุนูู ุงูุฌุงูุจ ุงูุญุฑูู ูุงูุชูุงุตูู.</p>
                     <p class="text-sm text-gray-500 mt-4">ููุถุญ ุงูุฑุณู ุงูุจูุงูู ุงูุชูุฒูุน ุงูุชูุถูุญู ูุฃุจุฑุฒ ุฃููุงุน ุงูุฅุนุงูุงุช ุงูุชู ูุฏ ุชุญุชุงุฌ ูุฏุนู ูู ุงูุชุนููู ุงูุฃููู.</p>
                </div>
                <div class="chart-container md:col-span-2">
                    <canvas id="disabilitiesChart"></canvas>
                </div>
             </div>
             
             <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4 text-center">ุชูููู ุงูููุงุฑุณุงุช ุงูุชุฑุจููุฉ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center border-t-4 border-[#118AB2]">
                    <div class="text-5xl mb-4 text-[#118AB2]">๐งฉ</div>
                    <h4 class="text-xl font-bold mb-3">ุทูู ุงูุชูุญุฏ (Asperger)</h4>
                    <p class="text-sm text-gray-600 mb-2 font-bold">ุจูุฆุฉ ููุธูุฉ ููุฏูุก</p>
                    <ul class="list-disc list-inside text-right text-sm space-y-1">
                        <li>ูุณุงูุฑุฉ ุงูุณููู ุงูููุทู ูุฌุฐุจ ุงูุงูุชุจุงู ูุงูุชุฑููุฒ.</li>
                        <li>ุชูููุฑ ููุงู ุขูู ููุงุฏุฆ ูู ุนูุฏ ุงูุญุงุฌุฉ ููุนุฒูุฉ.</li>
                        <li>ุชูููู ุฒููู ูู (ูุณุงุนุฏ) ูุชุนุฒูุฒ ุงูุชูุงุตู ุงูุงุฌุชูุงุนู.</li>
                    </ul>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center border-t-4 border-[#06D6A0]">
                    <div class="text-5xl mb-4 text-[#06D6A0]">โค๏ธ</div>
                    <h4 class="text-xl font-bold mb-3">ูุชูุงุฒูุฉ ุฏุงูู (Down Syndrome)</h4>
                    <p class="text-sm text-gray-600 mb-2 font-bold">ุจุณุงุทุฉ ูุฎุทูุงุช ูุชุฏุฑุฌุฉ</p>
                    <ul class="list-disc list-inside text-right text-sm space-y-1">
                        <li>ุฅุจุนุงุฏ ุงููุดุชุชุงุช ุงูุจุตุฑูุฉ ูุงูุณูุนูุฉ ุฏุงุฎู ุงูุตู.</li>
                        <li>ุชูููู ุงูููุงู ุงููุจูุฑุฉ ุฅูู ุฎุทูุงุช ุตุบูุฑุฉ ูุจุณุทุฉ.</li>
                        <li>ุงุณุชุฎุฏุงู ุงูุชุดุฌูุน ูุงูุชุญููุฒ ุงููุณุชูุฑ ูุฃุฏุงุฉ ููุชุนูู.</li>
                    </ul>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center border-t-4 border-[#FF6B6B]">
                    <div class="text-5xl mb-4 text-[#FF6B6B]">โฟ</div>
                    <h4 class="text-xl font-bold mb-3">ุงูุฅุนุงูุฉ ุงูุญุฑููุฉ / ุงูุญุณูุฉ</h4>
                     <p class="text-sm text-gray-600 mb-2 font-bold">ุชูููู ุงููุถุงุก ูุงูุฃุฏูุงุช</p>
                     <ul class="list-disc list-inside text-right text-sm space-y-1">
                        <li>ุงุฎุชูุงุฑ ููุงู ุฃูุณุจ ููุทูู ูุณูู ุญุฑูุชู ูุฏุฎููู ูุฎุฑูุฌู.</li>
                        <li>ุงูุงูุชุจุงู ููุถุนูุฉ ุฌููุณ ุงูุทูู ุนูุฏ ุงุณุชุฎุฏุงู ุงูุทุงููุฉ (ููุญูุงุธ ุนูู ุณูุงูุฉ ุงูุฌุณุฏ).</li>
                        <li>ูุถุน ูุณุงุฆู ุฏูุฏุงูุชูููุฉ **ููููุฉ** ุฑูู ุฅุดุงุฑุชู ููุฑุณู ุฃู ุงููุชุงุจุฉ.</li>
                    </ul>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center border-t-4 border-[#FFD166]">
                    <div class="text-5xl mb-4 text-[#FFD166]">๐ง</div>
                    <h4 class="text-xl font-bold mb-3">ุงุถุทุฑุงุจุงุช ุงูุชุนูู ุงููุญุฏุฏุฉ</h4>
                    <p class="text-sm text-gray-600 mb-2 font-bold">ูุฑููุฉ ูู ุงูุฅููุงุน ูุงูุชูููู</p>
                    <ul class="list-disc list-inside text-right text-sm space-y-1">
                        <li>ุชุฎุตูุต ููุช ุฅุถุงูู ูุฅูุฌุงุฒ ุงูููุงู ูุนุฏู ูุฑุถ ููุณ ูุชูุฑุฉ ุจุงูู ุงูุฃุทูุงู.</li>
                        <li>ุชุฌุงูุฒ ุงูุฃุฎุทุงุก ุงูุจุณูุทุฉ ูู ุงููุทู ุฃู ุงูุชุนุจูุฑ ุงูููุชูุจ ูุคูุชูุง.</li>
                        <li>ูุฐุง ุงูุงุถุทุฑุงุจ ูุง ูุนูุณ **ููุฏุงุฑ ุฐูุงุก ุงูุทูู** ุจู ูุคุซุฑ ุนูู ูุฏุฑุชู ุนูู ุงูุฅูุฌุงุฒ ุงูุฃูุงุฏููู.</li>
                    </ul>
                </div>

            </div>
        </section>

        <section id="abuse_consequences" class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#FF6B6B] mb-6">ุงููุดุงุท ุงูุซุงูุซ: ุฅุณุงุกุฉ ุงููุนุงููุฉ ูุนูุงูุจูุง</h2>
            <p class="text-center text-lg max-w-4xl mx-auto mb-8">ุงูุฃุทูุงู ุฐูู ุงูุงุญุชูุงุฌุงุช ุงูุฎุงุตุฉ ุฃูุซุฑ ุนุฑุถุฉ ููุฅุณุงุกุฉ. ููู ุงูุฅุณุงุกุฉ ูุนูุงูุจูุง ุฃูุฑ ุญููู ูุงุชุฎุงุฐ ุฅุฌุฑุงุกุงุช ุงูุญูุงูุฉ ุงููุนุงูุฉ.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div class="bg-white rounded-lg shadow-md p-6 border-r-8 border-[#FF6B6B]">
                    <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4">ุฃุดูุงู ุงูุฅุณุงุกุฉ ุงูุฃุฑุจุนุฉ</h3>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="text-3xl text-[#FF6B6B]">๐</span>
                            <div>
                                <h4 class="font-bold text-[#073B4C]">ุงูุฅููุงู ุฃู ุงูุญุฑูุงู</h4>
                                <p class="text-sm">ุงููุดู ูู ุชูุจูุฉ ุงูุงุญุชูุงุฌุงุช ุงูุฃุณุงุณูุฉ ููุทูู (ุบุฐุงุกุ ุฑุนุงูุฉ ุตุญูุฉุ ุชุนููู).</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-3xl text-[#FF6B6B]">๐ค</span>
                            <div>
                                <h4 class="font-bold text-[#073B4C]">ุงูุฅูุฐุงุก ุงูุฌุณุฏู</h4>
                                <p class="text-sm">ุงุณุชุฎุฏุงู ุงูููุฉ ุงูุฐู ูุคุฏู ุฅูู ุถุฑุฑ ุฃู ุฅุตุงุจุฉ ุจุฏููุฉ.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-3xl text-[#FF6B6B]">๐ฃ๏ธ</span>
                            <div>
                                <h4 class="font-bold text-[#073B4C]">ุงูุฅูุฐุงุก ุงูุนุงุทูู (ุงูููุณู)</h4>
                                <p class="text-sm">ุงูุณููู ุงูุฐู ูุถุฑ ุจุงูููู ุงูููุณู ุฃู ุงูุงุฌุชูุงุนู ููุทูู (ูุซู ุงูุฅูุงูุฉ ุงููุณุชูุฑุฉ).</p>
                            </div>
                        </div>
                         <div class="flex items-start gap-3">
                            <span class="text-3xl text-[#FF6B6B]">๐ซ</span>
                            <div>
                                <h4 class="font-bold text-[#073B4C]">ุงูุงุณุชุบูุงู ุฃู ุงูุงุนุชุฏุงุก ุงูุฌูุณู</h4>
                                <p class="text-sm">ุฃู ุดูู ูู ุฃุดูุงู ุงุณุชุบูุงู ุถุนู ุงูุทูู ุฃู ุงูุชุนุฑุถ ูู ุฌูุณูุงู.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-8 border-[#073B4C]">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-4">ุงูุนูุงูุจ ุนูู ุงูููู ูุงูุตุญุฉ</h3>
                    <div class="space-y-6">
                        <div class="bg-[#FFD166]/30 p-4 rounded-lg">
                            <h4 class="text-xl font-bold text-[#073B4C] mb-1">ุงููุฏู ุงููุตูุฑ: ุงูุชุฃุซูุฑ ุงูููุฑู</h4>
                            <p class="text-sm">ูุคุฏู ุงูุฅูุฐุงุก ุฅูู ูุฑุท ูุดุงุท ุงูููุงุทู ุงูุฏูุงุบูุฉ ุงููุณุคููุฉ ุนู ุงูุฎูู ูุงููููุ ููุง ูุณุจุจ ุตุนูุจุงุช ูู **ุงูุชุฑููุฒ** ู **ุงูุชุนูู** ู **ุงูุชูุงุนู ุงูุงุฌุชูุงุนู**.</p>
                        </div>
                        <div class="bg-[#FF6B6B]/30 p-4 rounded-lg">
                            <h4 class="text-xl font-bold text-[#073B4C] mb-1">ุงููุฏู ุงูุทููู: ุงููุฎุงุทุฑ ุงูุตุญูุฉ</h4>
                            <p class="text-sm">ุชุฑุชุจุท ุฅุณุงุกุฉ ุงููุนุงููุฉ ูู ุงูุทูููุฉ ุจุฒูุงุฏุฉ ูุฎุงุทุฑ ุงูุณููููุงุช ุงูุถุงุฑุฉุ ูุซู ุงูุชุฏุฎููุ ูุงูุณููุฉุ ูุชุนุงุทู ุงููุฎุฏุฑุงุชุ ูุงุฑุชูุงุน ุงุญุชูุงููุฉ ุงูุฅุตุงุจุฉ **ุจุฃูุฑุงุถ ูุฒููุฉ** ูู ุงูุจููุบ.</p>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- GEMINI API FEATURE: Communication Draft Generator -->
            <div class="bg-[#FFD166]/20 p-6 rounded-lg shadow-inner mt-8 relative">
                <h3 class="text-2xl font-bold text-[#073B4C] text-center mb-4">โจ ููููุฏ ูุณูุฏุฉ ุงูุชูุงุตู ูุน ุงูุฃุณุฑ</h3>
                <p class="text-center text-sm text-gray-700 mb-4">ุงูุชุจ ุจูุถูุญ ุงูุณููู ุฃู ุงูุนูุงูุฉ ุงูุชู ูุงุญุธุชูุง (ูุซุงู: ุงูุงูุณุญุงุจ ุงูููุงุฌุฆุ ูุฏูุฉ ุบูุฑ ูุจุฑุฑุฉุ ููุจุงุช ุบุถุจ ูุชูุฑุฑุฉ) ููุญุตูู ุนูู ูุณูุฏุฉ ุฑุณุงูุฉ ููููุฉ ูููุงูุฏูู.</p>

                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <textarea id="observed-behavior" rows="2" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FFD166] text-right md:w-2/3 w-full" placeholder="ุงูุณููู ุงูููุงุญุธ ุฃู ุนูุงูุฉ ุงูุฎุทุฑ..."></textarea>
                    
                    <button onclick="generateCommunicationDraft()" class="llm-button py-3 px-6 rounded-lg shadow-md md:w-1/3 w-full flex items-center justify-center">
                        โจ ุชูููุฏ ูุณูุฏุฉ ุฑุณุงูุฉ ููุฃุณุฑ
                    </button>
                </div>

                 <div id="communication-draft-result-container" class="mt-6 bg-white p-4 rounded-lg shadow-inner relative min-h-[50px]">
                    <div id="communication-draft-loading" class="loading-overlay hidden">
                        <div class="spinner"></div>
                        <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุงูุชูููุฏ... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                    </div>
                    <div id="communication-draft-result" class="text-right text-gray-800">
                        <!-- Results will appear here -->
                        <p class="text-gray-500 italic">ุณุชุธูุฑ ููุง ูุณูุฏุฉ ุฑุณุงูุฉ ููููุฉ ูููุงูุฏูู.</p>
                    </div>
                </div>
            </div>
            
        </section>

        <section id="protection" class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#118AB2] mb-6">ุงููุดุงุท ุงูุฑุงุจุน: ุฏูุฑ ุงููุฑุจู ุงููุนุงู ูู ุฏูุฑุฉ ุงูุญูุงูุฉ</h2>
            <p class="text-center text-lg max-w-4xl mx-auto mb-8">ูุฌุจ ุนูู ุงููุฑุจู ุงุชุจุงุน ุชุณูุณู ูููุฌู ูุถูุงู ุญูุงูุฉ ุงูุฃุทูุงู ูู ูุถุนูุฉ ุฅุนุงูุฉ ูู ุงูุฅูุฐุงุก ุฃู ุงูุฅููุงู.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-0">
                <div class="flowchart-step bg-white rounded-lg shadow-md p-4 w-56 text-center border-t-4 border-[#073B4C]">
                    <h4 class="font-bold text-[#073B4C]">1. ุงููุนู ูุงูุฅููุงู</h4>
                    <p class="text-sm">ููู ุฎุตุงุฆุต ุงูุฃุทูุงู ูุฅุฏุฑุงู ุฃุดูุงู ุงูุฅุณุงุกุฉ ุงููุญุชููุฉ.</p>
                </div>
                <div class="flowchart-arrow mx-4 hidden md:block">โ</div>
                 <div class="flowchart-arrow my-2 md:hidden">โฌ</div>
                <div class="flowchart-step bg-white rounded-lg shadow-md p-4 w-56 text-center border-t-4 border-[#118AB2]">
                    <h4 class="font-bold text-[#118AB2]">2. ุงูููุงูุฉ ุงููุดุทุฉ</h4>
                    <p class="text-sm">ุงุชุฎุงุฐ ุชุฏุงุจูุฑ ุงุณุชุจุงููุฉ ูุชุฃููู ุงูุจูุฆุฉ ููุญุฏ ูู ุฃู ุงูุชูุงูุงุช.</p>
                </div>
                 <div class="flowchart-arrow mx-4 hidden md:block">โ</div>
                 <div class="flowchart-arrow my-2 md:hidden">โฌ</div>
                <div class="flowchart-step bg-white rounded-lg shadow-md p-4 w-56 text-center border-t-4 border-[#06D6A0]">
                    <h4 class="font-bold text-[#06D6A0]">3. ุงูุงูุชุดุงู ูุงูููุงุญุธุฉ</h4>
                    <p class="text-sm">ุงูุชุนุฑู ุจุฏูุฉ ุนูู ุงูุนูุงูุงุช ุงูุฌุณุฏูุฉ ูุงูุณููููุฉ ุงูุฏุงูุฉ ุนูู ุงูุฅุณุงุกุฉ.</p>
                </div>
                 <div class="flowchart-arrow mx-4 hidden md:block">โ</div>
                 <div class="flowchart-arrow my-2 md:hidden">โฌ</div>
                <div class="flowchart-step bg-white rounded-lg shadow-md p-4 w-56 text-center border-t-4 border-[#FFD166]">
                    <h4 class="font-bold text-[#FFD166]">4. ุงูุฅุจูุงุบ ุงููุณุคูู</h4>
                    <p class="text-sm">ููู ุงููุนูููุงุช ุจูุณุคูููุฉ ุฅูู ุงูุฌูุงุช ุงููุฎุชุตุฉ ูุงููุนููุฉ ุจุงูุฏุนู.</p>
                </div>
                 <div class="flowchart-arrow mx-4 hidden md:block">โ</div>
                 <div class="flowchart-arrow my-2 md:hidden">โฌ</div>
                <div class="flowchart-step bg-white rounded-lg shadow-md p-4 w-56 text-center border-t-4 border-[#FF6B6B]">
                    <h4 class="font-bold text-[#FF6B6B]">5. ุงูุฅุญุงูุฉ ุงููุชุฎุตุตุฉ</h4>
                    <p class="text-sm">ุชูุฌูู ุงูุทูู ูุญู ุฎุฏูุงุช ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ูุงูููุณูุฉ ุงููุงุฒูุฉ.</p>
                </div>
            </div>
            
            <!-- GEMINI API FEATURE: Classroom Image Analyzer -->
            <div class="bg-[#118AB2]/20 p-6 rounded-lg shadow-inner mt-8 relative">
                <h3 class="text-2xl font-bold text-[#073B4C] text-center mb-4">โจ ููุญูููู ุตูุฑ ุงููุณู ุงูุฏุงูุฌ</h3>
                <p class="text-center text-sm text-gray-700 mb-4">ูู ุจุชุญููู ุตูุฑุฉ ููุณูู. ุณููุฏู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุชููููุงู ููุชูุธูู ูุงูุชุฑุงุญุงุช ูุชุญุณูู ุงูุฅุฏูุงุฌ.</p>
                
                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <input type="file" id="classroom-image-input" accept="image/*" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118AB2] text-right md:w-2/3 w-full bg-white">
                    
                    <button onclick="analyzeClassroomImage()" class="llm-button py-3 px-6 rounded-lg shadow-md md:w-1/3 w-full flex items-center justify-center">
                        โจ ุชุญููู ุงููุณู ุงูุฏุงูุฌ
                    </button>
                </div>

                <div id="image-preview-container" class="text-center">
                    <!-- Image preview will be here -->
                </div>

                 <div id="classroom-analysis-result-container" class="mt-6 bg-white p-4 rounded-lg shadow-inner relative min-h-[50px]">
                    <div id="classroom-analysis-loading" class="loading-overlay hidden">
                        <div class="spinner"></div>
                        <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                    </div>
                    <div id="classroom-analysis-result" class="text-right text-gray-800">
                        <p class="text-gray-500 italic">ุณุชุธูุฑ ููุง ูุชุงุฆุฌ ุงูุชุญููู ุงูุชููุงุฆู ูุน ุชูุตูุงุช ูุจูุฆุฉ ุฏุงูุฌุฉ.</p>
                    </div>
                </div>
            </div>

             <!-- GEMINI API FEATURE: Protection Idea Generator -->
            <div class="bg-slate-200 p-6 rounded-lg shadow-inner mt-8 relative">
                <h3 class="text-2xl font-bold text-[#073B4C] text-center mb-4">โจ ููููุฏ ุฃููุงุฑ ุงูุญูุงูุฉ ูุงูููุงูุฉ</h3>
                <p class="text-center text-sm text-gray-700 mb-4">ุงุฎุชุฑ ููุน ุงูุฅุณุงุกุฉ ูุชูููุฏ ููุฑุฉ ูุดุงุท ููุงุฆู ูุญุฏุฏ ููุจุชูุฑ ูููุฑุจู ูุชุทุจููู ูู ุงููุณู.</p>

                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <select id="abuse-type" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FF6B6B] text-right md:w-1/3 w-full">
                        <option value="">ุงุฎุชุฑ ููุน ุงูุฅุณุงุกุฉ...</option>
                        <option value="ุงูุฅููุงู ุฃู ุงูุญุฑูุงู">ุงูุฅููุงู ุฃู ุงูุญุฑูุงู (๐)</option>
                        <option value="ุงูุฅูุฐุงุก ุงูุฌุณุฏู">ุงูุฅูุฐุงุก ุงูุฌุณุฏู (๐ค)</option>
                        <option value="ุงูุฅูุฐุงุก ุงูุนุงุทูู (ุงูููุณู)">ุงูุฅูุฐุงุก ุงูุนุงุทูู (ุงูููุณู) (๐ฃ๏ธ)</option>
                        <option value="ุงูุงุณุชุบูุงู ุฃู ุงูุงุนุชุฏุงุก ุงูุฌูุณู">ุงูุงุณุชุบูุงู ุฃู ุงูุงุนุชุฏุงุก ุงูุฌูุณู (๐ซ)</option>
                    </select>
                    
                    <button onclick="generateProtectionIdea()" class="llm-button py-3 px-6 rounded-lg shadow-md md:w-1/3 w-full flex items-center justify-center">
                        โจ ุชูููุฏ ููุฑุฉ ููุงุฆูุฉ ุนูููุฉ
                    </button>
                </div>

                 <div id="protection-idea-result-container" class="mt-6 bg-white p-4 rounded-lg shadow-inner relative min-h-[50px]">
                    <div id="protection-idea-loading" class="loading-overlay hidden">
                        <div class="spinner"></div>
                        <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุงูุชูููุฏ... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                    </div>
                    <div id="protection-idea-result" class="text-right text-gray-800">
                        <!-- Results will appear here -->
                        <p class="text-gray-500 italic">ุณุชุธูุฑ ููุง ููุฑุฉ ูุดุงุท ููุงุฆู.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- GEMINI API FEATURE: Case Study Generator -->
        <section id="case-study-generator" class="mb-12 bg-[#073B4C] p-6 rounded-lg shadow-xl relative">
            <h2 class="text-3xl font-bold text-center text-white mb-6">โจ ุฃุฏุงุฉ ุชูููุฏ ุฏุฑุงุณุงุช ุงูุญุงูุฉ ููุชุฏุฑูุจ</h2>
            <p class="text-center text-gray-300 max-w-4xl mx-auto mb-6">
                ุงุณุชุฎุฏู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชูููุฏ ุณููุงุฑูู ุชุฏุฑูุจู ูุงูุนูุ ูุชุถูู ุชูุตูุงุช ููุฑูุฉ ูุชูููู ุงููุณู.
            </p>

            <div class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="disability-type" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118AB2] text-right" placeholder="ููุน ุงูุฅุนุงูุฉ (ูุซุงู: ุชูุญุฏุ ุฏุงููุ ุญุฑููุฉ)">
                <input type="text" id="specific-challenge" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118AB2] text-right" placeholder="ุงูุชุญุฏู ุงููุญุฏุฏ (ูุซุงู: ุตุนูุจุฉ ุงูุชูุงุตู ุงูุจุตุฑูุ ูุฑุท ุงูุญุฑูุฉ)">
                
                <button onclick="generateCaseStudy()" class="llm-button py-3 px-4 rounded-lg shadow-md transform hover:scale-[1.01] flex items-center justify-center">
                    โจ ุชูููุฏ ุฏุฑุงุณุฉ ุญุงูุฉ ูุชูุตูุงุช
                </button>
            </div>
            
            <div id="case-study-result-container" class="mt-6 bg-slate-100 p-6 rounded-lg relative min-h-[100px]">
                <div id="case-study-loading" class="loading-overlay hidden">
                    <div class="spinner"></div>
                    <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุงูุชูููุฏ... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                </div>
                <div id="case-study-result" class="text-right text-gray-800">
                    <!-- Results will appear here -->
                    <p class="text-gray-500 italic">ุณูุชู ุนุฑุถ ุงูุณููุงุฑูู ุงูุชุฑุจูู ูุงูุชูุตูุงุช ููุง ุจุนุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ.</p>
                </div>
            </div>
        </section>
        
        <!-- NEW GEMINI API FEATURE: Behavioral Observation Summarizer -->
        <section id="observation-summarizer" class="mb-12 bg-[#FFD166] p-6 rounded-lg shadow-xl relative">
            <h2 class="text-3xl font-bold text-center text-[#073B4C] mb-6">โจ ูููุฎููุต ููุงุญุธุงุช ุงูุณููู ูุงูููู</h2>
            <p class="text-center text-gray-800 max-w-4xl mx-auto mb-6">
                ุฃูุตู ุงูููุงุญุธุงุช ุงูููููุฉ ุบูุฑ ุงูููุธูุฉ ูุทูู ูุนูู. ุณูููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุชูุธูููุงุ ูุชุตููููุง ุญุณุจ ูุฌุงูุงุช ุงูููู (ุงูุงุฌุชูุงุนูุ ุงููุนุฑููุ ุงูุญุฑูู)ุ ูุชูููุฑ ุชูุฑูุฑ ููุฌุฒ.
            </p>

            <div class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 gap-4 items-end">
                <label for="observation-notes" class="block text-sm font-medium text-gray-700 mb-1 text-right">ุงูููุงุญุธุงุช ุงูููููุฉ ุบูุฑ ุงูููุธูุฉ ููุทูู (ูู ุญุฏูุฏ 200 ูููุฉ)</label>
                <textarea id="observation-notes" rows="6" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FFD166] text-right w-full" placeholder="ูุซุงู: ุงููููุ ุฑูุถ ุฃุญูุฏ ุงูุงูุถูุงู ุฅูู ุฑูู ุงูุจูุงุกุ ูุจูู ุนูุฏูุง ุฃุทูุฃุช ุงูุฃุถูุงุก ูุฌุฃุฉ. ููููู ุชููู ูู ุชูุฏูุณ 5 ุญููุงุช ุนูู ุงูุนููุฏ ุจูุณุงุนุฏุฉ ุจุณูุทุฉ ูู ุฒูููู. ูุนูุฏูุง ุชุญุฏุซุช ุฅูููุ ูุฑุฑ ุงููููุงุช ุงูุชู ููุชูุง."></textarea>
                
                <button onclick="summarizeObservationNotes()" class="llm-button py-3 px-4 rounded-lg shadow-md flex items-center justify-center bg-gradient-to-r from-[#073B4C] to-[#118AB2] mt-4">
                    โจ ุชุญููู ูุชูุฎูุต ุงูููุงุญุธุงุช
                </button>
            </div>
            
            <div id="observation-result-container" class="mt-6 bg-slate-100 p-6 rounded-lg relative min-h-[100px]">
                <div id="observation-loading" class="loading-overlay hidden">
                    <div class="spinner"></div>
                    <p class="mr-4 text-[#073B4C] font-semibold">ุฌุงุฑู ุชุญููู ุงูููุงุญุธุงุช... ูุฑุฌู ุงูุงูุชุธุงุฑ.</p>
                </div>
                <div id="observation-result" class="text-right text-gray-800 structured-output">
                    <!-- Results will appear here -->
                    <p class="text-gray-500 italic">ุณูุชู ุนุฑุถ ุงูุชูุฑูุฑ ุงูููุธู ูุงูููุฎุต ูููุงุญุธุงุชู ููุง.</p>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-[#073B4C] text-white text-center p-4 mt-8">
        <p>ูุตูุบุฉ ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู</p>
    </footer>

    <script>
        // --- Utility Functions for TTS and API Calls ---
        const API_KEY = "AIzaSyBHACHhOdIzfKc21RiX1VCZOV99LhS353U"; // If you want to use models other than gemini-2.5-flash-preview-05-20, provide an API key here. Otherwise, leave this as-is.

        /**
         * Converts a base64 string to an ArrayBuffer.
         * @param {string} base64 - The base64 encoded string.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Converts PCM data (Int16Array) to a WAV Blob.
         * @param {Int16Array} pcm16 - The signed 16-bit PCM audio data.
         * @param {number} sampleRate - The sample rate.
         * @returns {Blob}
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            /* RIFF identifier */
            view.setUint32(0, 0x52494646, false); // "RIFF"
            /* file length */
            view.setUint32(4, 36 + pcm16.length * 2, true);
            /* RIFF type */
            view.setUint32(8, 0x57415645, false); // "WAVE"
            /* format chunk identifier */
            view.setUint32(12, 0x666d7420, false); // "fmt "
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (1 for PCM) */
            view.setUint16(20, 1, true);
            /* number of channels */
            view.setUint16(22, numChannels, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sampleRate * blockAlign) */
            view.setUint32(28, byteRate, true);
            /* block align (numChannels * bitsPerSample/8) */
            view.setUint16(32, blockAlign, true);
            /* bits per sample */
            view.setUint16(34, bitsPerSample, true);
            /* data chunk identifier */
            view.setUint32(36, 0x64617461, false); // "data"
            /* data chunk length */
            view.setUint32(40, pcm16.length * 2, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * Generic function to call Gemini API with exponential backoff.
         * @param {string} model - The model to use.
         * @param {object} payload - The request payload.
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<object>} - The parsed JSON response.
         */
        async function callGeminiApiWithRetry(model, payload, maxRetries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Rate limit error, retry with exponential backoff
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Other errors or last retry failed
                        const errorBody = await response.json();
                        console.error('API Error:', response.status, errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Throw the error after the last retry
                    }
                    // Continue to the next retry
                }
            }
        }

        // --- TTS Implementation ---

        /**
         * Reads the definition aloud using Gemini TTS API.
         */
        async function readDefinition() {
            const textToRead = document.getElementById('inclusive-definition').innerText;
            const ttsButton = document.querySelector('button[onclick="readDefinition()"]');
            ttsButton.disabled = true;
            ttsButton.innerHTML = 'ุฌุงุฑู ุงูุชุญุถูุฑ...';
            const audio = document.getElementById('tts-audio');

            const payload = {
                contents: [{
                    parts: [{ text: textToRead }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            // Using a clear and firm Arabic-compatible voice (Kore often works well for formal tone)
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        },
                        languageCode: "ar-EG" // Specify Arabic language
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-tts", payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    // Cleanup previous URL
                    if (audio.src) URL.revokeObjectURL(audio.src);
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audio.src = audioUrl;
                    
                    ttsButton.innerHTML = '๐ ุฌุงุฑู ุงููุฑุงุกุฉ...';
                    
                    audio.play().catch(e => console.error("Audio play failed:", e));

                    audio.onended = () => {
                        ttsButton.innerHTML = '๐ ุงูุฑุฃ ุงูุชุนุฑูู (TTS)';
                        ttsButton.disabled = false;
                    };

                } else {
                    console.error("Invalid TTS response format or missing data.");
                    ttsButton.innerHTML = 'โ ุฎุทุฃ ูู ุงูุตูุช';
                }

            } catch (error) {
                console.error("TTS generation failed:", error);
                ttsButton.innerHTML = 'โ ูุดู ุงูุงุชุตุงู';
            } finally {
                if(audio.paused || !audio.src) {
                    // Only re-enable if not currently playing (e.g., failed to start or source is missing)
                    ttsButton.disabled = false;
                }
            }
        }

        // --- Communication Draft Generator Implementation ---
        async function generateCommunicationDraft() {
            const observedBehavior = document.getElementById('observed-behavior').value.trim();
            const resultDiv = document.getElementById('communication-draft-result');
            const loadingDiv = document.getElementById('communication-draft-loading');
            const generateButton = document.querySelector('#abuse_consequences .llm-button');

            if (!observedBehavior) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ูุตู ุงูุณููู ุงูููุงุญุธ ุฃู ุนูุงูุฉ ุงูุฎุทุฑ ุฃููุงู.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = 'ุฌุงุฑู ุงูุชูููุฏ...';
            resultDiv.innerHTML = '';

            const userQuery = `
                ุฃูุง ูุฑุจู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู ูุฃุฑุบุจ ูู ุงูุชูุงุตู ูุน ููู ุฃูุฑ ุงูุทูู ุจุดุฃู ุณููู ุฃู ุนูุงูุฉ ุฎุทุฑ ูุงุญุธุชูุง.
                ุงูุณููู ุงูููุงุญุธ ูู: "${observedBehavior}".
                ุงูุฑุฌุงุก ุตูุงุบุฉ ุฑุณุงูุฉ ููููุฉุ ุญุณุงุณุฉุ ููุญุงูุฏุฉ (ูุง ุชุญุชูู ุนูู ุงุชูุงู ูุจุงุดุฑ) ููุฌูุฉ ูููู ุงูุฃูุฑ.
                ูุฌุจ ุฃู ุชุชุถูู ุงูุฑุณุงูุฉ:
                1. ุชุนุจูุฑุงู ุนู ุงูููู ูุงููุฏู ูู ุงูุชูุงุตู (ุงูุชุนุงูู ูุฎูุฑ ุงูุทูู).
                2. ูุตูุงู ุฏูููุงู ูููุถูุนูุงู ููุณููู ุงูููุงุญุธ.
                3. ุฏุนูุฉ ูููุงุก ุฃู ุงุชุตุงู ูููุงูุดุฉ ุงูุฃูุฑ ุจุชูุตูู.
                ูุฌุจ ุฃูุง ุชุฒูุฏ ุงูุฑุณุงูุฉ ุนู 100 ูููุฉุ ูุงูุชุจูุง ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุจุฃุณููุจ ุฑุณูู ููููู.
            `;
            
            const systemPrompt = "ุฃูุช ูุณุชุดุงุฑ ุชุฑุจูู ูุชุฎุตุต ูู ุงูุชูุงุตู ูุน ุงูุฃุณุฑ ุจุดุฃู ุตุนูุจุงุช ุงูุฃุทูุงู. ูููุชู ูู ุฅูุดุงุก ูุณูุฏุฉ ุฑุณุงูุฉ ุชูุงุตู ููููุฉ ููุญุชุฑูุฉ ููุจููุฉ ุนูู ุงูููุงุญุธุฉุ ูุชุดุฌูุน ุงูุชุนุงูู ุฏูู ุฅุซุงุฑุฉ ุฑุฏ ูุนู ุฏูุงุนู.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุงููุณูุฏุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
                
                // Simple markdown-to-HTML conversion for better rendering
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); // Double newline to paragraph

                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'โจ ุชูููุฏ ูุณูุฏุฉ ุฑุณุงูุฉ ููุฃุณุฑ';
            }
        }

        // --- Classroom Image Analyzer Implementation ---

        // Function to convert a File object to a Base64 data URL
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only need the base64 part
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Handle file change to show a preview
        document.getElementById('classroom-image-input').addEventListener('change', function() {
            const file = this.files[0];
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = ''; // Clear previous preview

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview mx-auto';
                    img.style.maxWidth = '100%';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });


        async function analyzeClassroomImage() {
            const imageInput = document.getElementById('classroom-image-input');
            const file = imageInput.files[0];
            const resultDiv = document.getElementById('classroom-analysis-result');
            const loadingDiv = document.getElementById('classroom-analysis-loading');
            const analyzeButton = document.querySelector('#protection button[onclick="analyzeClassroomImage()"]');

            if (!file) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ุชุญููู ุตูุฑุฉ ุฃููุงู.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = 'ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ...';
            resultDiv.innerHTML = '';

            try {
                const base64ImageData = await getBase64(file);
                
                const userQuery = `
                    ุญูู ุงูุตูุฑุฉ ุงูุชุงููุฉ ูุตู ุชุนููู ุฃููู (ุฑูุถุฉ) ููุฏู ุชููููุงู ุดุงููุงู ููุฏู ุฏุนูู ููุชุฑุจูุฉ ุงูุฏุงูุฌุฉ (Inclusive Education).
                    ูุฌุจ ุฃู ูุชุถูู ุงูุชูููู ุฌุฒุฃูู ุฑุฆูุณููู:
                    1. ุงูููุงุญุธุงุช: ุงุฐูุฑ 3-5 ููุงุท ููุฉ ูููุงุท ุถุนู ูู ุชูุธูู ุงูุตู ูุนุฑุถ ุงูููุงุฏ ุงูุชุนููููุฉ ูู ููุธูุฑ ุงูุฅุฏูุงุฌ ูุงูุฃุทูุงู ุฐูู ุงูุงุญุชูุงุฌุงุช ุงูุฎุงุตุฉ (ูุซู ุงูุชูุญุฏุ ุงูุฅุนุงูุฉ ุงูุญุฑููุฉุ ุตุนูุจุงุช ุงูุชุนูู).
                    2. ุงูุชูุตูุงุช: ูุฏู 3 ุชูุตูุงุช ุนูููุฉ ููุญุฏุฏุฉ ูุชูููู ุงูุจูุฆุฉ ุจูุงุกู ุนูู ุงูููุงุญุธุงุช ูุฒูุงุฏุฉ ุดููููุฉ ุงูุตู.
                    ุงูุชุจ ุงูุฑุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุน ุชูุณูู ููู ุจุงุณุชุฎุฏุงู ุฑุคูุณ ูุฃูุณุงู.
                `;
                
                const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุตููู ุงููุถุงุกุงุช ุงูุชุนููููุฉ ุงูุฏุงูุฌุฉ ููุฑุญูุฉ ุงูุชุนููู ุงูุฃููู (ุงูุฑูุถุฉ). ูููุชู ูู ุชุญููู ุงูุตูุฑ ูุชูุฏูู ุชูุงุฑูุฑ ุฏูููุฉ ูููุตูุฉ ูุน ุชูุตูุงุช ูุชุญููู ุฃูุตู ูุฏุฑ ูู ุงูุดููููุฉ ูุงูุฃูุงู ููุฃุทูุงู ุฐูู ุงูุงุญุชูุงุฌุงุช ุงูุฎุงุตุฉ.";

                const payload = {
                    contents: [
                        { role: "user", parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64ImageData
                                }
                            }
                        ]}
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุงูุชุญููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุตูุฑุฉ ุฃูุถุญ.';
                
                // Simple markdown-to-HTML conversion for better rendering
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                formattedText = formattedText.replace(/### (.*?)(\n|$)/g, '<h4 class="text-xl font-bold text-[#073B4C] mt-4 mb-2 border-b border-[#118AB2] pb-1">$1</h4>'); // H3 to H4
                formattedText = formattedText.replace(/## (.*?)(\n|$)/g, '<h3 class="text-2xl font-bold text-[#118AB2] mt-6 mb-3">$1</h3>'); // H2 to H3
                formattedText = formattedText.replace(/(\* |-) (.*?)(\n|$)/g, '<li class="list-disc list-inside mr-6">$2</li>'); // Lists
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); // Double newline to paragraph
                formattedText = formattedText.replace(/<p class="mt-2 mb-2"><li/g, '<p><li'); // Fix for list preceding paragraph

                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุชุฃูุฏ ูู ุฃู ุงูุตูุฑุฉ ูุงุถุญุฉ ูุตูุบุชูุง ุตุญูุญุฉ. (${error.message})</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'โจ ุชุญููู ุงููุณู ุงูุฏุงูุฌ';
            }
        }


        // --- Case Study Generator Implementation ---
        async function generateCaseStudy() {
            const disabilityType = document.getElementById('disability-type').value.trim();
            const specificChallenge = document.getElementById('specific-challenge').value.trim();
            const resultDiv = document.getElementById('case-study-result');
            const loadingDiv = document.getElementById('case-study-loading');
            const generateButton = document.querySelector('#case-study-generator button.llm-button');

            if (!disabilityType || !specificChallenge) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ุฅุฏุฎุงู ููุน ุงูุฅุนุงูุฉ ูุงูุชุญุฏู ุงููุญุฏุฏ.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = 'ุฌุงุฑู ุงูุชูููุฏ...';
            resultDiv.innerHTML = '';

            const userQuery = `
                ูู ุจุชูููุฏ ุฏุฑุงุณุฉ ุญุงูุฉ ููุตูุฉ ูููุฌุฒุฉ ููุนูู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู (ูุง ูุจู ุงููุฏุฑุณุฉ).
                ููุน ุงูุฅุนุงูุฉ: ${disabilityType}.
                ุงูุชุญุฏู ุงููุญุฏุฏ ุงูุฐู ููุงุฌูู ุงูุทูู ูู ุงููุณู: ${specificChallenge}.
                ูุฌุจ ุฃู ูุชุถูู ุงูุฑุฏ ุฌุฒุฃูู:
                1. ุณููุงุฑูู ุงูุทูู ูุงููุถุน ุงูุญุงูู.
                2. 3-5 ุชูุตูุงุช ุนูููุฉ ููุญุฏุฏุฉ ูููุนูู ูุชูููู ุงูุจูุฆุฉ ูุงูููุงุฑุณุงุช ูู ุงููุณู ูุฏุนู ุงูุทูู.
                ุงูุชุจ ุงูุฑุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุน ุชูุณูู ููู ุจุงุณุชุฎุฏุงู ุฑุคูุณ ูุฃูุณุงู.
            `;
            
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ูุชุทููุฑ ุฎุทุท ุงูุฏุนู ุงููุฑุฏูุฉ (PEI) ููุฃุทูุงู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู. ูููุชู ูู ุฅูุดุงุก ุฏุฑุงุณุงุช ุญุงูุฉ ูุงูุนูุฉ ูุชูุตูุงุช ุชุฑุจููุฉ ุนูููุฉ ููุจุงุดุฑุฉ ูููุนูููู.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุฏุฑุงุณุฉ ุงูุญุงูุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
                
                // Simple markdown-to-HTML conversion for better rendering
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                formattedText = formattedText.replace(/### (.*?)(\n|$)/g, '<h4 class="text-xl font-bold text-[#073B4C] mt-4 mb-2">$1</h4>'); // H3 to H4
                formattedText = formattedText.replace(/## (.*?)(\n|$)/g, '<h3 class="text-2xl font-bold text-[#118AB2] mt-6 mb-3">$1</h3>'); // H2 to H3
                formattedText = formattedText.replace(/(\* |-) (.*?)(\n|$)/g, '<li class="list-disc list-inside mr-6">$2</li>'); // Lists
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); // Double newline to paragraph
                formattedText = formattedText.replace(/<p class="mt-2 mb-2"><li/g, '<p><li'); // Fix for list preceding paragraph

                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'โจ ุชูููุฏ ุฏุฑุงุณุฉ ุญุงูุฉ ูุชูุตูุงุช';
            }
        }

        // --- Protection Idea Generator Implementation ---
        async function generateProtectionIdea() {
            const abuseTypeSelect = document.getElementById('abuse-type');
            const abuseType = abuseTypeSelect.value;
            const resultDiv = document.getElementById('protection-idea-result');
            const loadingDiv = document.getElementById('protection-idea-loading');
            const generateButton = document.querySelector('#protection button[onclick="generateProtectionIdea()"]');


            if (!abuseType) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุฅุณุงุกุฉ ุฃููุงู.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = 'ุฌุงุฑู ุงูุชูููุฏ...';
            resultDiv.innerHTML = '';

            const userQuery = `
                ุฃูุง ูุฑุจู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู (3-5 ุณููุงุช).
                ุฃุญุชุงุฌ ุฅูู ููุฑุฉ ูุดุงุท ููุงุฆู (ูู ุญุฏูุฏ 70 ูููุฉ) ูููููู ุชุทุจููู ูุจุงุดุฑุฉ ูู ุงููุณู ูุญูุงูุฉ ุงูุฃุทูุงู ูู ุฎุทุฑ ${abuseType}.
                ูุฌุจ ุฃู ุชููู ุงูููุฑุฉ:
                1. ุนูููุฉ ูููุงุณุจุฉ ูุณู ูุง ูุจู ุงููุฏุฑุณุฉ.
                2. ุชุฑูุฒ ุนูู ุงูููุงูุฉ ุงููุดุทุฉ ูุชุนููู ุงูุฃุทูุงู ุญุฏูุฏ ุฌุณุฏูู ุฃู ุญููููู ุจุทุฑููุฉ ุจุณูุทุฉ.
                ุงุจุฏุฃ ุงูุฑุฏ ุจุนููุงู ููู ููุฎุชุตุฑ ุซู ุงูููุฑุฉ ุงูุนูููุฉ. ูุง ุชุณุชุฎุฏู ุนูุงูุงุช ุชูุตูุต.
            `;
            
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุญูุงูุฉ ุงูุทูู ูุชุทููุฑ ุฃูุดุทุฉ ุงููุนู ูุงูุญูุงูุฉ ุงูููุงุฆูุฉ ููุฑุญูุฉ ุงูุชุนููู ุงูุฃููู. ูููุชู ูู ุชูุฏูู ููุฑุฉ ูุดุงุท ูุงุญุฏุ ุนููู ูุณูู ุงูุชุทุจูู.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุงูููุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
                
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); // Double newline to paragraph

                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'โจ ุชูููุฏ ููุฑุฉ ููุงุฆูุฉ ุนูููุฉ';
            }
        }
        
        // --- Inclusive Activity Generator Implementation ---
        async function generateInclusiveActivity() {
            const topic = document.getElementById('activity-topic').value.trim();
            const duration = document.getElementById('activity-duration').value.trim();
            const resultDiv = document.getElementById('activity-result');
            const loadingDiv = document.getElementById('activity-loading');
            const generateButton = document.querySelector('#activity-generator button.llm-button');

            if (!topic) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ุฅุฏุฎุงู ุงูููุถูุน ุฃู ุงููุฏู ุงูุชุนูููู ุฃููุงู.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = 'ุฌุงุฑู ุงูุชูููุฏ...';
            resultDiv.innerHTML = '';

            const userQuery = `
                ุฃูุง ูุฑุจู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู (3-5 ุณููุงุช).
                ุฃุฑูุฏ ูุดุงุทุงู ุชุทุจูููุงู ุญูู ุงูููุถูุน: **${topic}**. ุงููุฏุฉ ุงูููุชุฑุญุฉ ูู **${duration} ุฏูููุฉ**.
                ุงูุฑุฌุงุก ุชูููุฏ ุฎุทุฉ ูุดุงุท ููุตูุฉ ูููุฌุฒุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ุชุดูู:
                1. **ุงุณู ุงููุดุงุท** ููุฏูู ุงูุชุนูููู.
                2. **ุฎุทูุงุช ุงูุชูููุฐ** (3-4 ุฎุทูุงุช ุฑุฆูุณูุฉ).
                3. **ุชูุตูุงุช ุงูุฅุฏูุงุฌ ูุงูุชูููู** (3-4 ููุงุท) ููุฌูุฉ ุฎุตูุตุงู ููุฃุทูุงู ุฐูู ุงูุฅุนุงูุฉ (ูุซู ุงูุชูุญุฏุ ุงูุฅุนุงูุฉ ุงูุญุฑููุฉุ ุตุนูุจุงุช ุงูุชุนูู) ูุถูุงู ูุดุงุฑูุชูู ุงููุนุงูุฉ.
                ุงุณุชุฎุฏู ุชูุณูู ููู (ุนูุงููู ุฌุฑูุฆุฉ ูููุงุฆู).
            `;

            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุทููุฑ ุงูููุงูุฌ ุงูุชุนููููุฉ ุงูุฏุงูุฌุฉ ููุฑุญูุฉ ูุง ูุจู ุงููุฏุฑุณุฉ. ูููุชู ูู ุฅูุดุงุก ุฎุทุท ุฃูุดุทุฉ ุฅุจุฏุงุนูุฉ ููุงุจูุฉ ููุชูููุฐ ูู ุงููุตูุ ูุน ุงูุชุฑููุฒ ุงูููู ุนูู ุงูุชููููุงุช ุงููุงุฒูุฉ ููุฅุฏูุงุฌ.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุงููุดุงุท. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
                
                // Simple markdown-to-HTML conversion for better rendering
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                formattedText = formattedText.replace(/### (.*?)(\n|$)/g, '<h4 class="text-xl font-bold text-[#073B4C] mt-4 mb-2 border-b border-[#06D6A0] pb-1">$1</h4>'); // H3 to H4
                formattedText = formattedText.replace(/## (.*?)(\n|$)/g, '<h3 class="text-2xl font-bold text-[#118AB2] mt-6 mb-3">$1</h3>'); // H2 to H3
                formattedText = formattedText.replace(/(\* |-) (.*?)(\n|$)/g, '<li class="list-disc list-inside mr-6">$2</li>'); // Lists
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); // Double newline to paragraph
                formattedText = formattedText.replace(/<p class="mt-2 mb-2"><li/g, '<p><li'); // Fix for list preceding paragraph

                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'โจ ุชูููุฏ ูุดุงุท ุฏุงูุฌ';
            }
        }

        // --- NEW: Behavioral Observation Summarizer Implementation ---
        async function summarizeObservationNotes() {
            const notes = document.getElementById('observation-notes').value.trim();
            const resultDiv = document.getElementById('observation-result');
            const loadingDiv = document.getElementById('observation-loading');
            const generateButton = document.querySelector('#observation-summarizer button.llm-button');

            if (!notes) {
                resultDiv.innerHTML = '<p class="text-red-600 font-bold">ูุฑุฌู ุฅุฏุฎุงู ุงูููุงุญุธุงุช ุฃููุงู ูุจุฏุก ุงูุชุญููู.</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = 'ุฌุงุฑู ุชุญููู ุงูููุงุญุธุงุช...';
            resultDiv.innerHTML = '';

            const userQuery = `
                ุฃูุง ูุฑุจู ูู ูุฑุญูุฉ ุงูุชุนููู ุงูุฃููู. ูุฏู ุงูููุงุญุธุงุช ุงูููููุฉ ุบูุฑ ุงูููุธูุฉ ุงูุชุงููุฉ ุนู ุทูู ูุงุญุฏ:
                """
                ${notes}
                """
                ุงูุฑุฌุงุก ุชุญููู ูุฐู ุงูููุงุญุธุงุช ูุชูุฏูู ุชูุฑูุฑ ููุฌุฒ ูููุธู ุจุงููุบุฉ ุงูุนุฑุจูุฉ. ูุฌุจ ุฃู ูุชุถูู ุงูุชูุฑูุฑ ูุง ููู:
                1. **ููุฎุต ุงููุชุงุฆุฌ**: ููุฑุฉ ูุงุญุฏุฉ ุชูุฎุต ุจุดูู ุงุญุชุฑุงูู ูุณุชูู ูุดุงุฑูุฉ ุงูุทูู ูุณูููู ุงูุนุงู.
                2. **ุชูุฒูุน ุงูููุงุญุธุงุช ุญุณุจ ุงููุฌุงู**: ูุงุฆูุฉ ููุธูุฉ ุชุตูู ุงูููุงุญุธุงุช ุฅูู ูุฌุงูุงุช (ูุซู: **ุงููุฌุงู ุงูุงุฌุชูุงุนู/ุงูุนุงุทูู**ุ **ุงููุฌุงู ุงููุนุฑูู/ุงููุบูู**ุ **ุงููุฌุงู ุงูุญุฑูู/ุงูููุงุฑุงุช ุงูุฏูููุฉ**).
                3. **ุชูุตูุฉ ููุฅุฌุฑุงุก ุงูุชุงูู**: ุงูุชุฑุงุญ ูุงุญุฏ ูุญุฏุฏ ููุจุงุดุฑ (ูุซุงู: ุงูุชุฑููุฒ ุนูู ุชูุงุฑูู ุงูููุงุฑุงุช ุงูุฏูููุฉุ ุฃู ุงูุชุดุงูุฑ ูุน ุฃุฎุตุงุฆู ุงูุชูุญุฏ).
                ุงุณุชุฎุฏู ุชูุณูู Markdown ููู ููุนูุงููู ูุงูููุงุฆู ูุชุณููู ุงููุฑุงุกุฉ.
            `;

            const systemPrompt = "ุฃูุช ุฃุฎุตุงุฆู ูู ุนูู ููุณ ุงูููู ูุงูุชุฑุจูุฉ ุงูุฏุงูุฌุฉ ููุฑุญูุฉ ุงูุชุนููู ุงูุฃููู. ูููุชู ูู ุชุญููู ุงูููุงุญุธุงุช ุงูููููุฉ ุงูุฎุงู ุฅูู ุชูุงุฑูุฑ ุชููููุฉ ููููุฉ ูููุฌูุฉ ูุญู ุงูุนููุ ููุงุณุจุฉ ููููุงุช ุงูุฃุทูุงู ุฃู ุงูุชูุงุตู ูุน ุงูุฃูู ูุงูุฃุฎุตุงุฆููู.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApiWithRetry("gemini-2.5-flash-preview-05-20", payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ุชุนุฐุฑ ุชูููุฏ ุงูุชูุฑูุฑ. ูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู ุงูููุงุญุธุงุช ูุงุถุญุฉ.';
                
                // Detailed Markdown-to-HTML conversion for specific structure
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold titles
                formattedText = formattedText.replace(/(\* |-) (.*?)(\n|$)/g, '<li>$2</li>'); // List items
                formattedText = formattedText.replace(/<strong>(.*?)<\/strong>/g, '</strong></ul><strong>$1</strong><ul>'); // Wrap content between bold titles in <ul>
                
                // Add an initial <ul> before the first list and remove the starting </ul> and the closing <strong> tag if empty
                if (formattedText.startsWith('</strong>')) {
                    formattedText = formattedText.substring(9);
                }
                formattedText = formattedText.startsWith('<ul>') ? formattedText : '<ul>' + formattedText;
                formattedText = formattedText.endsWith('<ul>') ? formattedText.substring(0, formattedText.length - 4) : formattedText + '</ul>';
                
                // Replace remaining newlines with paragraphs, avoiding breaking list structure
                formattedText = formattedText.replace(/<\/ul>\s*<p class="mt-2 mb-2">/g, '<\/ul><p class="mt-2 mb-2">');
                formattedText = formattedText.replace(/(\n\n)/g, '<p class="mt-2 mb-2">'); 
                formattedText = formattedText.replace(/<p class="mt-2 mb-2"><strong>/g, '<strong>');
                
                // Final cleanup for paragraphs outside lists
                formattedText = formattedText.replace(/(<\/ul>)(.*?)(\s*<strong>)/gs, (match, p1, p2, p3) => {
                    const content = p2.trim().replace(/<p class="mt-2 mb-2">/g, ''); // Clean up stray paragraph tags in the middle
                    if (content) {
                        return `${p1}<p class="mt-2 mb-2">${content}</p>${p3}`;
                    }
                    return `${p1}${p3}`;
                });


                resultDiv.innerHTML = formattedText;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 font-bold">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'โจ ุชุญููู ูุชูุฎูุต ุงูููุงุญุธุงุช';
            }
        }


        // --- Chart.js Initialization ---
        function wrapLabel(label) {
            const maxLength = 16;
            if (label.length <= maxLength) {
                return label;
            }
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length > maxLength) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + ' ' + word).trim();
                }
            });
            if (currentLine) {
                lines.push(currentLine.trim());
            }
            return lines;
        }

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            } else {
                return label;
            }
        };

        window.onload = function() {
            const disabilitiesCtx = document.getElementById('disabilitiesChart').getContext('2d');
            const disabilitiesChart = new Chart(disabilitiesCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        'ุงุถุทุฑุงุจุงุช ุงูุชุนูู ุงููุญุฏุฏุฉ', 
                        'ุทูู ุงูุชูุญุฏ', 
                        'ุงูุฅุนุงูุงุช ุงูุญุณูุฉ ูุงูุญุฑููุฉ', 
                        'ูุชูุงุฒูุฉ ุฏุงูู / ุฅุนุงูุฉ ุฐูููุฉ'
                    ].map(wrapLabel),
                    datasets: [{
                        label: 'ูุณุจุฉ ุงูุชุญุฏูุงุช (ุชูุถูุญู)',
                        data: [45, 25, 15, 15],
                        backgroundColor: [
                            '#FF6B6B',
                            '#FFD166',
                            '#06D6A0',
                            '#118AB2',
                        ],
                        hoverOffset: 15,
                        borderWidth: 5,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                 font: {
                                    family: "'Tajawal', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'ุงูุชูุฒูุน ุงูุชูุฏูุฑู ููุฅุนุงูุงุช ูู ุงููุณู ุงููุฏูุฌ',
                            font: {
                                family: "'Tajawal', sans-serif",
                                size: 16
                            }
                        },
                        tooltip: {
                            rtl: true,
                            bodyFont: {
                                 family: "'Tajawal', sans-serif"
                            },
                            titleFont: {
                                family: "'Tajawal', sans-serif"
                            },
                            callbacks: {
                               title: tooltipTitleCallback,
                               label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        if (Array.isArray(label)) {
                                             label = label.join(' ');
                                        }
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                               }
                            }
                        }
                    }
                }
            });
        }
    </script>

</body>
</html>
